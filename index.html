function calculateSettings() {
    const bpm = parseInt(document.getElementById('bpm').value) || 180;
    const hiSpeedInput = document.getElementById('hi-speed');
    let hiSpeed = parseFloat(hiSpeedInput.value) || 3.75;
    const greenInput = document.getElementById('green-number');
    let greenNumber = parseInt(greenInput.value) || 300;

    // Spline interpolation for HI-SPEED limits (linear for simplicity)
    const bpmPoints = [78, 180, 400];
    const hiSpeedPoints = [8.5, 3.75, 1.5];
    let hiSpeedLimit;
    if (bpm <= bpmPoints[0]) hiSpeedLimit = hiSpeedPoints[0];
    else if (bpm >= bpmPoints[2]) hiSpeedLimit = hiSpeedPoints[2];
    else {
        if (bpm <= bpmPoints[1]) {
            const t = (bpm - bpmPoints[0]) / (bpmPoints[1] - bpmPoints[0]);
            hiSpeedLimit = hiSpeedPoints[0] + t * (hiSpeedPoints[1] - hiSpeedPoints[0]);
        } else {
            const t = (bpm - bpmPoints[1]) / (bpmPoints[2] - bpmPoints[1]);
            hiSpeedLimit = hiSpeedPoints[1] + t * (hiSpeedPoints[2] - hiSpeedPoints[1]);
        }
    }

    // Check HI-SPEED limit
    const warningEn = document.getElementById('hi-speed-warning');
    const warningJp = document.getElementById('hi-speed-warning-jp');
    if (hiSpeed > hiSpeedLimit) {
        warningEn.classList.remove('hidden');
        warningJp.classList.remove('hidden');
    } else {
        warningEn.classList.add('hidden');
        warningJp.classList.add('hidden');
    }

    // Green Number calculation: G = 202500 / (BPM * HI-SPEED)
    if (document.activeElement === document.getElementById('bpm') || document.activeElement === document.getElementById('hi-speed')) {
        greenNumber = Math.round(202500 / (bpm * hiSpeed));
        if (greenNumber < 1) greenNumber = 1;
        greenInput.value = greenNumber;
    } else if (document.activeElement === document.getElementById('green-number')) {
        hiSpeed = 202500 / (bpm * greenNumber);
        hiSpeed = Math.round(hiSpeed * 100) / 100;
        if (hiSpeed < 0.5) hiSpeed = 0.5;
        if (hiSpeed > 10) hiSpeed = 10;
        hiSpeedInput.value = hiSpeed;
    }

    // Note Display Adjust: Scaled with BPM and HI-SPEED, constrained to -20 to +20
    let noteAdjust = Math.round(-6 * (180 / bpm) * (hiSpeed / 3.75));
    if (noteAdjust < -20) noteAdjust = -20;
    if (noteAdjust > 20) noteAdjust = 20;
    document.getElementById('note-adjust').value = noteAdjust;

    // Judgment Line Position: Scaled with HI-SPEED, constrained to 0–20
    let judgeLine = Math.round(8 * (hiSpeed / 3.75));
    if (judgeLine < 0) judgeLine = 0;
    if (judgeLine > 20) judgeLine = 20;
    document.getElementById('judge-line').value = judgeLine;

    // SHUTTER (IN): Scaled with HI-SPEED, constrained to 0–30
    let shutterIn = Math.round(25 * (hiSpeed / 3.75));
    if (shutterIn < 0) shutterIn = 0;
    if (shutterIn > 30) shutterIn = 30;
    document.getElementById('shutter-in').value = shutterIn;

    // White Number: Half of Green Number
    const whiteNumber = Math.round(greenNumber / 2);
    document.getElementById('white-number').value = whiteNumber;

    saveSettings();
}
